---
phase: 04-narrative-beat-extraction-and-manifest-generation
plan: "02"
subsystem: narrative
tags: [generator, manifest-assembly, cli-stage5, beat-classification, scoring, overlap-resolution, unit-tests]

# Dependency graph
requires:
  - phase: 04-01
    provides: signals.py (extract_all_signals, get_film_duration_s) and scorer.py (normalize_all_signals, compute_money_shot_score, classify_beat, assign_act)
  - phase: 02-manifest-contract-vibes-and-conform
    provides: ClipEntry/TrailerManifest schema, VIBE_PROFILES, load_manifest
  - phase: 01-ingestion-pipeline-and-cli-shell
    provides: KeyframeRecord, DialogueEvent, CLI scaffold
provides:
  - cinecut.narrative.generator: run_narrative_stage, compute_clip_window, resolve_overlaps, get_dialogue_excerpt, get_nearest_emotion, get_transition, build_reasoning
  - CLI Stage 5 wiring: run_narrative_stage called after Stage 4 inference, manifest loaded for optional conform
  - tests/test_narrative.py: 31 unit tests covering NARR-02, NARR-03, EDIT-01
affects: [Phase 5 conform pipeline -- trailer_manifest now generated by Stage 5 instead of requiring --manifest flag]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Direct-import mock targeting (mock cinecut.narrative.generator.get_film_duration_s, not signals)
    - Act-boundary transition selection (cold_open/beat_drop/act3 use secondary_transition)
    - 0.5s gap enforcement via resolve_overlaps before ClipEntry construction
    - Degenerate window skip (end <= start clips filtered before ClipEntry creation)

key-files:
  created:
    - src/cinecut/narrative/generator.py
    - tests/test_narrative.py
  modified:
    - src/cinecut/cli.py

key-decisions:
  - "Mock target is cinecut.narrative.generator.get_film_duration_s (not signals module) because generator imports it directly via 'from ... import'"
  - "get_nearest_emotion is a separate function from get_dialogue_excerpt -- returns emotion str (not float) for classify_beat input"
  - "run_narrative_stage calls progress_callback after scoring each frame (not after clip writing) so progress tracks the scoring loop"
  - "Degenerate clips (end <= start after resolve_overlaps) are silently filtered, not raised as errors"
  - "TrailerManifest requires min_length=1 clips -- test data uses 24 frames ensuring enough clips survive filtering"

patterns-established:
  - "Manifest assembly: score -> select top-N -> sort chronologically -> compute windows -> resolve overlaps -> build entries"
  - "Act boundary transitions use secondary_transition; all other acts use primary_transition"
  - "CLI Stage 5 progress bar tracks frame scoring, not clip writing (scoring is the slow loop)"

requirements-completed: [EDIT-01]

# Metrics
duration: 4min
completed: 2026-02-26
---

# Phase 4 Plan 02: Generator, CLI Stage 5, and Test Suite Summary

**Manifest assembly pipeline (top-N scored clips, chronological sort, overlap-free windows) wired into CLI as Stage 5 with Rich progress bar; 31 unit tests covering beat classification, signal scoring, and manifest generation**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-26T21:55:16Z
- **Completed:** 2026-02-26T21:58:40Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Implemented generator.py with 7 functions: compute_clip_window (act-to-duration mapping, 30/70 bias), resolve_overlaps (0.5s gap enforcement), get_dialogue_excerpt (direct-overlap preference, midpoint proximity fallback), get_nearest_emotion (emotion string for beat classifier), get_transition (act boundary vs primary), build_reasoning (structured string), run_narrative_stage (full pipeline)
- Wired CLI Stage 5 with Rich Progress bar (SpinnerColumn + BarColumn + TimeElapsedColumn), progress callback tracking scoring loop, manifest written and loaded into trailer_manifest for optional conform
- Updated CLI summary panel from "Phase 3 Complete" to "Phase 4 Complete" with manifest path included
- Created tests/test_narrative.py with 31 tests: NARR-02 (10 tests), NARR-03 (6 tests), EDIT-01 (5 manifest generation tests), internal helper tests (10 tests)
- 96 tests passing total (was 65 before plan 02)

## Task Commits

Each task was committed atomically:

1. **Task 1: Implement generator.py** - `b2ad971` (feat)
2. **Task 2: Wire CLI Stage 5 and write test_narrative.py** - `f75c954` (feat)

**Plan metadata:** _(docs commit follows)_

## Files Created/Modified

- `src/cinecut/narrative/generator.py` - Full manifest assembly pipeline: 7 helper functions + run_narrative_stage
- `src/cinecut/cli.py` - Added Stage 5 progress block + run_narrative_stage import + updated summary panel
- `tests/test_narrative.py` - 31 unit tests covering NARR-02, NARR-03, EDIT-01

## Decisions Made

- Mock target is `cinecut.narrative.generator.get_film_duration_s` (not the signals module) because generator imports the function directly via `from ... import` -- the bound name lives in the generator namespace
- `get_nearest_emotion` is a separate function from `get_dialogue_excerpt` -- both look up nearest events but return different types (str emotion vs str text)
- `run_narrative_stage` calls `progress_callback` after scoring each frame (the slow loop) rather than after writing each clip
- Degenerate clips (end <= start after resolve_overlaps) are filtered silently, consistent with the plan's "skip clips where end <= start" instruction

## Deviations from Plan

None - plan executed exactly as written. The mock target deviation (signals vs generator module) was a correctness fix during test validation, not a plan deviation.

## Issues Encountered

- Initial test mocking targeted `cinecut.narrative.signals.get_film_duration_s` but generator imports the function directly so the correct mock target is `cinecut.narrative.generator.get_film_duration_s`. Fixed immediately (Rule 1 - Bug).

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 5 (FFmpeg conform) can now receive a generated manifest from Stage 5 instead of requiring a hand-crafted --manifest flag
- trailer_manifest is set after Stage 5 so the existing conform block runs automatically after manifest generation
- All 96 non-inference tests passing; schema backward compatible with all 21 manifest fixture tests

## Self-Check: PASSED

- generator.py: FOUND
- test_narrative.py: FOUND
- 04-02-SUMMARY.md: FOUND
- Commit b2ad971: FOUND
- Commit f75c954: FOUND

---
*Phase: 04-narrative-beat-extraction-and-manifest-generation*
*Completed: 2026-02-26*
