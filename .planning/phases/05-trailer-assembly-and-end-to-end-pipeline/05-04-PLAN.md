---
phase: 05-trailer-assembly-and-end-to-end-pipeline
plan: 04
type: execute
wave: 3
depends_on:
  - 05-03
files_modified: []
autonomous: false
requirements:
  - EDIT-02
  - EDIT-03
  - PIPE-04

must_haves:
  truths:
    - "A complete end-to-end run from cinecut <film> --subtitle <srt> --vibe <name> produces a playable trailer MP4"
    - "The trailer MP4 contains clips in 3-act order (cold_open through act3, then title card and button)"
    - "Average cut duration is shorter in act3 than act1 (pacing curve observable in output)"
    - "Interrupting mid-run and re-running resumes from the last completed stage (not from scratch)"
  artifacts:
    - path: "src/cinecut/checkpoint.py"
      provides: "PipelineCheckpoint atomic read/write"
      exports: ["PipelineCheckpoint", "load_checkpoint", "save_checkpoint"]
    - path: "src/cinecut/assembly/__init__.py"
      provides: "assemble_manifest() 3-act orchestrator"
      exports: ["assemble_manifest"]
    - path: "src/cinecut/assembly/ordering.py"
      provides: "sort_clips_by_act, enforce_pacing_curve"
      exports: ["sort_clips_by_act", "enforce_pacing_curve"]
    - path: "src/cinecut/assembly/title_card.py"
      provides: "generate_title_card, get_video_dimensions"
      exports: ["generate_title_card", "get_video_dimensions"]
    - path: "src/cinecut/cli.py"
      provides: "7-stage CLI with checkpoint guards"
      contains: "TOTAL_STAGES"
    - path: "tests/test_checkpoint.py"
      provides: "PIPE-04 unit tests"
    - path: "tests/test_assembly.py"
      provides: "EDIT-02, EDIT-03 unit tests"
  key_links:
    - from: "cinecut CLI"
      to: "work_dir/pipeline_checkpoint.json"
      via: "save_checkpoint() after each stage"
      pattern: "save_checkpoint"
    - from: "conform_manifest()"
      to: "title_card.mp4 + button.mp4"
      via: "extra_clip_paths appended to concat list"
      pattern: "extra_clip_paths"
    - from: "ASSEMBLY_MANIFEST.json"
      to: "canonical act order in output trailer"
      via: "conform_manifest receives reordered_manifest"
      pattern: "reordered_manifest"
---

<objective>
Human verify that the complete Phase 5 pipeline produces a playable trailer with 3-act structure, observable pacing curve, and functional checkpoint/resume behavior.

Purpose: This is the final acceptance gate for Phase 5. All four requirements (EDIT-02, EDIT-03, PIPE-04) must be verified by running the actual pipeline on a test film.

Output: Confirmed playable trailer MP4 with 3-act structure, working checkpoint resume, and sign-off that Phase 5 is complete.
</objective>

<execution_context>
@/home/adamh/.claude/get-shit-done/workflows/execute-plan.md
@/home/adamh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/05-trailer-assembly-and-end-to-end-pipeline/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated pre-verify — test suite passes and structure checks</name>
  <files></files>
  <action>
Run the full automated verification suite before human review. These checks confirm the implementation is structurally complete and all unit tests pass.

Run the following commands and confirm each passes:

```bash
cd /home/adamh/ai-video-trailer

# 1. Full non-inference unit test suite
python -m pytest tests/ -x -q --ignore=tests/test_inference.py -k "not integration"

# 2. CLI structural integrity
python -c "
from cinecut.checkpoint import PipelineCheckpoint, load_checkpoint, save_checkpoint
from cinecut.assembly import assemble_manifest
from cinecut.assembly.ordering import sort_clips_by_act, enforce_pacing_curve, ACT_ORDER
from cinecut.assembly.title_card import generate_title_card, get_video_dimensions
import inspect
from cinecut.conform.pipeline import conform_manifest
sig = inspect.signature(conform_manifest)
assert 'extra_clip_paths' in sig.parameters
import pathlib
src = pathlib.Path('src/cinecut/cli.py').read_text()
assert 'TOTAL_STAGES' in src
assert 'load_checkpoint' in src
assert 'assemble_manifest' in src
assert 'reordered_manifest' in src
print('ALL STRUCTURAL CHECKS PASS')
"

# 3. Verify checkpoint round-trip
python -c "
import tempfile
from pathlib import Path
from cinecut.checkpoint import PipelineCheckpoint, load_checkpoint, save_checkpoint
d = Path(tempfile.mkdtemp())
ckpt = PipelineCheckpoint(source_file='/tmp/film.mkv', vibe='action')
ckpt.mark_stage_complete('proxy')
save_checkpoint(ckpt, d)
loaded = load_checkpoint(d)
assert loaded.is_stage_complete('proxy')
assert not loaded.is_stage_complete('subtitles')
print('PASS: checkpoint round-trip')
"

# 4. Verify pacing curve test assertion
python -m pytest tests/test_assembly.py::TestEnforcePacingCurve::test_pacing_curve_decreasing_after_enforcement -v
```

If any check fails, fix the failure before proceeding to the human verify task.
  </action>
  <verify>
    <automated>cd /home/adamh/ai-video-trailer && python -m pytest tests/ -x -q --ignore=tests/test_inference.py -k "not integration" 2>&1 | tail -5</automated>
  </verify>
  <done>
    - All non-inference tests pass (0 failures)
    - Structural CLI checks pass (TOTAL_STAGES, load_checkpoint, assemble_manifest, reordered_manifest present)
    - Checkpoint round-trip passes
    - Pacing curve test passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verify end-to-end trailer production and checkpoint resume</name>
  <action>
Complete Phase 5 implementation is built:
- `src/cinecut/checkpoint.py` — atomic JSON checkpoint (PIPE-04)
- `src/cinecut/assembly/` package — 3-act ordering + pacing enforcement + title card (EDIT-02, EDIT-03)
- `src/cinecut/cli.py` — 7-stage pipeline with checkpoint guards around all stages
- `tests/test_checkpoint.py` and `tests/test_assembly.py` — unit test coverage
- `src/cinecut/conform/pipeline.py` — updated to accept `extra_clip_paths`
  </action>
  <verify>
**Verify 1 — End-to-End Pipeline (requires ~30-60 min):**

Run the full pipeline on any available test film with subtitles. Use a film already in the work directory from prior phases if one exists:
```bash
# Check for existing films from prior phases
ls /home/adamh/*.mkv /home/adamh/*.mp4 /home/adamh/*.avi 2>/dev/null | head -5
# Use any available film + subtitle pair
cinecut &lt;film.mkv&gt; --subtitle &lt;film.srt&gt; --vibe action
```

Expected: Pipeline runs stages 1-7, prints "Stage N/7:" for each, produces `&lt;film&gt;_trailer_action.mp4`.
Check: `ffprobe -v quiet -print_format json -show_streams &lt;film&gt;_trailer_action.mp4 | python -m json.tool | head -20`
Expected: Valid MP4 with video stream.

**Verify 2 — Checkpoint Resume:**

Interrupt a fresh run (Ctrl+C) after Stage 3 or 4. Re-run the same command.
Expected: CLI prints "Resuming: Stage N already complete" for completed stages.
Check: `cat &lt;work_dir&gt;/pipeline_checkpoint.json` — shows `stages_complete` list.

**Verify 3 — Pacing Curve Observable:**

After a successful run, inspect ASSEMBLY_MANIFEST.json:
```bash
python -c "
import json; from pathlib import Path
manifest = json.loads(Path('&lt;work_dir&gt;/ASSEMBLY_MANIFEST.json').read_text())
from cinecut.assembly.ordering import compute_act_avg_duration
from cinecut.manifest.schema import ClipEntry
clips = [ClipEntry(**c) for c in manifest['clips']]
act1 = compute_act_avg_duration(clips, 'act1')
act3 = compute_act_avg_duration(clips, 'act3')
print(f'Act1 avg: {act1:.2f}s  Act3 avg: {act3:.2f}s')
print('OK' if act1 &gt; act3 else 'WARNING: pacing not decreasing')
"
```

**Verify 4 — Title Card and Button Generated:**
```bash
ffprobe -v quiet -i &lt;work_dir&gt;/title_card.mp4 2&gt;&amp;1 | head -3
ffprobe -v quiet -i &lt;work_dir&gt;/button.mp4 2&gt;&amp;1 | head -3
```
Expected: Both exist (~5s and ~2s).

**Verify 5 — Stage Labels:** Fresh run shows "Stage 1/7:", "Stage 6/7:", "Stage 7/7:" in output.

If end-to-end is not practical (no test film), type "approved-unit-only" — unit tests cover all EDIT-02, EDIT-03, PIPE-04 behavioral contracts.
  </verify>
  <done>
User types "approved" (all 5 verified) or "approved-unit-only" (unit tests only).
Phase 5 is complete when either signal is received.
  </done>
</task>

</tasks>

<verification>
Phase 5 complete when:
1. `python -m pytest tests/ -q --ignore=tests/test_inference.py -k "not integration"` passes all tests
2. `src/cinecut/checkpoint.py`, `src/cinecut/assembly/` package all exist with correct exports
3. `cli.py` updated with 7-stage pipeline, checkpoint guards, Stage 6 assembly
4. `conform_manifest()` accepts `extra_clip_paths`
5. Human verify approved (end-to-end trailer or unit-only sign-off)
</verification>

<success_criteria>
- All automated checks pass (tests, structural imports, checkpoint round-trip)
- End-to-end: `cinecut <film> --subtitle <srt> --vibe action` produces a playable ~2-minute MP4
- Checkpoint resume: Re-running after interruption skips completed stages
- ASSEMBLY_MANIFEST.json shows act1_avg > act3_avg (pacing curve enforced)
- Stage labels show N/7 format in CLI output
</success_criteria>

<output>
After completion, create `.planning/phases/05-trailer-assembly-and-end-to-end-pipeline/05-04-SUMMARY.md`
</output>
