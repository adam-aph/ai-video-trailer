---
phase: 10-sfx-vo-and-audio-mix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cinecut/conform/sfx.py
autonomous: true
requirements:
  - SFXL-01
  - SFXL-02
  - SFXL-03
must_haves:
  truths:
    - "SFX WAV files are synthesized in work_dir/sfx/ exactly once per pipeline run (idempotent re-use)"
    - "Hard-cut transitions produce a short (0.4s) high-to-low chirp sweep"
    - "Act-boundary transitions produce a longer (1.2s) low-to-high chirp sweep with Gaussian envelope"
    - "SFX are positioned at beat-snapped cut boundaries with a quarter-duration lead so the sweep peaks at the cut"
    - "Zero external SFX files are required on disk — all sound generated from FFmpeg aevalsrc"
    - "All SFX synthesized at exactly 48000Hz stereo PCM"
  artifacts:
    - path: "src/cinecut/conform/sfx.py"
      provides: "synthesize_sfx_files(), apply_sfx_to_timeline() — SFX synthesis and timeline overlay"
      exports:
        - "synthesize_sfx_files"
        - "apply_sfx_to_timeline"
        - "SFX_HARD_DURATION_S"
        - "SFX_BOUNDARY_DURATION_S"
  key_links:
    - from: "src/cinecut/conform/sfx.py"
      to: "work_dir/sfx/sfx_hard.wav"
      via: "synthesize_sfx_files() — FFmpeg aevalsrc with linear chirp formula"
      pattern: "aevalsrc.*3000.*300.*0.4"
    - from: "src/cinecut/conform/sfx.py"
      to: "work_dir/sfx/sfx_boundary.wav"
      via: "synthesize_sfx_files() — Gaussian-enveloped chirp"
      pattern: "aevalsrc.*200.*2000.*1.2"
    - from: "src/cinecut/conform/sfx.py"
      to: "sfx_mix.wav (returned path)"
      via: "apply_sfx_to_timeline() — adelay overlay per cut position"
      pattern: "adelay.*\\|"
---

<objective>
Implement `conform/sfx.py` — the SFX synthesis module that generates two pre-rendered sweep WAV files via FFmpeg `aevalsrc` and overlays them at scene-cut positions using `adelay` timing.

Purpose: Fulfils SFXL-01, SFXL-02, SFXL-03 — synthesized transition swoosh SFX with no external file dependencies, two tiers (hard cut vs. act-boundary), all at 48000Hz.
Output: `src/cinecut/conform/sfx.py` — two public functions consumed by Phase 10 Plan 03.
</objective>

<execution_context>
@/home/adamh/.claude/get-shit-done/workflows/execute-plan.md
@/home/adamh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-sfx-vo-and-audio-mix/10-RESEARCH.md

<interfaces>
<!-- Key types and contracts from existing codebase. Executor uses these directly. -->

From src/cinecut/manifest/schema.py:
```python
class ClipEntry(BaseModel):
    source_start_s: float       # clip start in source film seconds
    source_end_s: float         # clip end in source film seconds
    beat_type: Literal[...]
    act: Literal["cold_open","act1","beat_drop","act2","breath","act3","title_card","button"]
    transition: Literal["hard_cut", "crossfade", "fade_to_black", "fade_to_white"] = "hard_cut"
    dialogue_excerpt: str = ""
    reasoning: Optional[str] = None
    visual_analysis: Optional[str] = None
    subtitle_analysis: Optional[str] = None
    money_shot_score: Optional[float] = None

class TrailerManifest(BaseModel):
    schema_version: str = "1.0"
    source_file: str
    vibe: str
    clips: list[ClipEntry]
    # Phase 9 additions (may be None if Phase 9 not yet executed):
    bpm_grid: Optional[BpmGrid] = None    # BpmGrid(bpm, beat_count, source, beat_times_s)
    music_bed: Optional[MusicBed] = None
```

From src/cinecut/errors.py (pattern):
```python
class ConformError(CineCutError):
    def __init__(self, path: Path, stderr: str) -> None: ...
```

From src/cinecut/conform/pipeline.py (FFmpeg subprocess pattern):
```python
result = subprocess.run(cmd, capture_output=True, text=True, check=False)
if result.returncode != 0:
    raise ConformError(output_path, result.stderr[-500:])
```

Phase 9 schema additions (present in TrailerManifest after Phase 9 executes):
- `manifest.bpm_grid.beat_times_s` — list of float, beat timestamps in seconds
- `manifest.clips[i].transition` — "hard_cut" | "crossfade" | "fade_to_black" | "fade_to_white"
- Act boundary: ESCALATION→CLIMAX transition is identified by clip.act changing from "act2"/"beat_drop" to "act3"
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conform/sfx.py — SFX synthesis and timeline overlay</name>
  <files>src/cinecut/conform/sfx.py</files>
  <action>
Create `src/cinecut/conform/sfx.py` with two public functions:

**Module-level constants:**
```python
SFX_HARD_DURATION_S: float = 0.4
SFX_BOUNDARY_DURATION_S: float = 1.2
```

**`synthesize_sfx_files(work_dir: Path) -> tuple[Path, Path]`:**
- Creates `work_dir/sfx/` directory (idempotent)
- Checks if both `work_dir/sfx/sfx_hard.wav` and `work_dir/sfx/sfx_boundary.wav` already exist — if so, return both paths immediately without calling FFmpeg (idempotent re-use, avoids ~2-3s on resume)
- Synthesizes `sfx_hard.wav` using FFmpeg aevalsrc: high-to-low linear chirp (3000Hz → 300Hz) over 0.4s, exponential decay envelope `0.6*exp(-3*t)`, stereo 48000Hz PCM
  - Correct chirp formula: `slope = (300 - 3000) / (2 * 0.4) = -3375`
  - Expression: `0.6*exp(-3*t)*sin(2*PI*(3000+(-3375)*t)*t)`
  - FFmpeg params: `-f lavfi -i "aevalsrc=EXPR:s=48000:d=0.4:c=stereo" -ar 48000 -ac 2 -c:a pcm_s16le sfx_hard.wav`
  - CRITICAL: use `c=stereo` NOT `cl=stereo` (aevalsrc channel layout param is `c`)
- Synthesizes `sfx_boundary.wav`: low-to-high chirp (200Hz → 2000Hz) over 1.2s, Gaussian envelope `0.5*(1-exp(-2*t))*exp(-0.5*(t-0.6)^2/0.15)`
  - slope = (2000 - 200) / (2 * 1.2) = 750
  - Expression: `0.5*(1-exp(-2*t))*exp(-0.5*pow(t-0.6,2)/0.15)*sin(2*PI*(200+750*t)*t)`
  - FFmpeg params: `-f lavfi -i "aevalsrc=EXPR:s=48000:d=1.2:c=stereo" -ar 48000 -ac 2 -c:a pcm_s16le sfx_boundary.wav`
- Raises `ConformError` if either FFmpeg call fails (returncode != 0)
- Returns `(sfx_hard_path, sfx_boundary_path)`

**`apply_sfx_to_timeline(manifest: TrailerManifest, sfx_hard: Path, sfx_boundary: Path, work_dir: Path, concat_duration_s: float) -> Path`:**
- Computes cut positions from the manifest clips assembled in order — each clip's timeline start is accumulated from preceding clip durations
- For each clip at timeline position `t_start_s`: classify the SFX tier
  - "hard_cut" transition → use `sfx_hard` (0.4s), position at `t_start_s - SFX_HARD_DURATION_S / 4` (0.1s lead) so sweep peaks at cut
  - "crossfade", "fade_to_black", "fade_to_white" transitions, OR when the clip is the first clip of "act3" (ESCALATION→CLIMAX boundary) → use `sfx_boundary` (1.2s), position at `t_start_s - SFX_BOUNDARY_DURATION_S / 4` (0.3s lead)
  - Skip clips with act "title_card" or "button" — no SFX for generated segments
  - Skip clip index 0 (no cut before the first clip)
- Clamp all SFX positions to >= 0.0s (don't go negative)
- Build an FFmpeg filtergraph using `amix` and `adelay` to overlay all SFX at their positions:
  - Each SFX input gets: `[N:a]adelay=OFFSET_MS|OFFSET_MS[sfxN]` where OFFSET_MS = int(position_s * 1000)
  - Mix all `[sfxN]` together with hard and boundary inputs: `[sfx0][sfx1]...amix=inputs=N:normalize=0[sfx_mix]`
  - If no cut positions found (single-clip manifest), copy sfx_hard to sfx_mix.wav and return immediately
- Output to `work_dir/sfx/sfx_mix.wav` at 48000Hz stereo PCM
- Raises `ConformError` if FFmpeg fails
- Returns path to `sfx_mix.wav`

**Import block:**
```python
import subprocess
from pathlib import Path
from cinecut.manifest.schema import TrailerManifest
from cinecut.errors import ConformError
```

Do NOT import from vibes.py or pipeline.py (keep sfx.py self-contained for Plan 03 wiring).
  </action>
  <verify>
    <automated>cd /home/adamh/ai-video-trailer && python -c "from cinecut.conform.sfx import synthesize_sfx_files, apply_sfx_to_timeline, SFX_HARD_DURATION_S, SFX_BOUNDARY_DURATION_S; print('import ok', SFX_HARD_DURATION_S, SFX_BOUNDARY_DURATION_S)"</automated>
  </verify>
  <done>
    - `from cinecut.conform.sfx import synthesize_sfx_files, apply_sfx_to_timeline` succeeds without error
    - `SFX_HARD_DURATION_S = 0.4`, `SFX_BOUNDARY_DURATION_S = 1.2`
    - `synthesize_sfx_files` signature accepts `work_dir: Path`, returns `tuple[Path, Path]`
    - `apply_sfx_to_timeline` signature accepts `(manifest, sfx_hard, sfx_boundary, work_dir, concat_duration_s)`, returns `Path`
    - Linear chirp formula uses `slope = (f1-f0)/(2*d)` (not `(f1-f0)/d`) — verified by inspecting aevalsrc expression in code
    - FFmpeg commands use `c=stereo` (not `cl=stereo`) in aevalsrc
    - adelay offsets computed as `int(position_s * 1000)` (milliseconds, not seconds)
  </done>
</task>

</tasks>

<verification>
Run from `/home/adamh/ai-video-trailer`:
```bash
python -c "from cinecut.conform.sfx import synthesize_sfx_files, apply_sfx_to_timeline, SFX_HARD_DURATION_S, SFX_BOUNDARY_DURATION_S; print('ok')"
python -m pytest tests/ -x -q --tb=short 2>&1 | tail -10
```
No import errors, existing tests pass.
</verification>

<success_criteria>
- `src/cinecut/conform/sfx.py` exists and imports cleanly
- `synthesize_sfx_files()` uses correct linear chirp formula (slope = `(f1-f0)/(2*d)`)
- `synthesize_sfx_files()` is idempotent — skips FFmpeg if WAV files already exist
- `apply_sfx_to_timeline()` uses `adelay` in milliseconds
- `amix normalize=0` used in filtergraph (MANDATORY per STATE.md decision)
- No external SFX files required (SFXL-03)
- All synthesis at 48000Hz stereo (AMIX-03 compliance)
</success_criteria>

<output>
After completion, create `.planning/phases/10-sfx-vo-and-audio-mix/10-01-SUMMARY.md`
</output>
