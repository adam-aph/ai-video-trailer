---
phase: 01-ingestion-pipeline-and-cli-shell
plan: "05"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cinecut/cli.py
  - tests/test_cli.py
autonomous: true
requirements: [CLI-02, CLI-03]
gap_closure: true

must_haves:
  truths:
    - "Running `cinecut movie.pdf ...` (extension wrong, file does not exist) shows a Rich 'Input Error' panel about unsupported format — not Typer's plain 'File does not exist' error"
    - "Running `cinecut nonexistent.mp4 ...` (extension valid, file does not exist) shows a Rich 'Input Error' panel about the file not existing"
    - "Extension check fires before existence check for both VIDEO and --subtitle arguments"
  artifacts:
    - path: "src/cinecut/cli.py"
      provides: "CLI with manual existence checks after extension checks; no exists=True on VIDEO or --subtitle"
      contains: "video.exists()"
    - path: "tests/test_cli.py"
      provides: "Unit tests for extension and existence validation order using Typer test runner"
      exports: ["test_invalid_video_extension_nonexistent_file", "test_valid_extension_nonexistent_file", "test_invalid_subtitle_extension"]
  key_links:
    - from: "tests/test_cli.py"
      to: "src/cinecut/cli.py"
      via: "typer.testing.CliRunner invoking app"
      pattern: "CliRunner.*app"
---

<objective>
Fix the CLI validation order so extension checks always run before existence checks for both the VIDEO argument and --subtitle option, producing consistent Rich error panels in all invalid-input cases.

Purpose: Typer's `exists=True` fires during argument parsing (before `main()` is entered), which means a wrong-extension file that doesn't exist on disk shows a plain Click error instead of our Rich error panel. The fix removes `exists=True` and adds manual `Path.exists()` checks inside `main()` after the extension checks. This closes UAT gap 2 and ensures CLI-02 and CLI-03 are fully satisfied.

Output: Updated cli.py with correct validation order and tests/test_cli.py covering validation edge cases.
</objective>

<execution_context>
@/home/adamh/.claude/get-shit-done/workflows/execute-plan.md
@/home/adamh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/adamh/ai-video-trailer/.planning/PROJECT.md
@/home/adamh/ai-video-trailer/.planning/ROADMAP.md
@/home/adamh/ai-video-trailer/.planning/STATE.md

Gap diagnosed in: /home/adamh/ai-video-trailer/.planning/debug/gap2-extension-validation-order.md

<interfaces>
<!-- Current cli.py structure (src/cinecut/cli.py):

  Line 44-53: VIDEO argument — typer.Argument(exists=True, ...)
  Line 54-63: subtitle option — typer.Option(exists=True, ...)
  Line 75-83: extension check for video (video.suffix.lower() not in _VALID_VIDEO_EXTS)
  Line 85-92: extension check for subtitle (subtitle.suffix.lower() not in _VALID_SUBTITLE_EXTS)

  PROBLEM: exists=True on lines 47 and 58 causes Click to validate file existence
  at parse time, before main() is entered. When a file doesn't exist, Click raises
  BadParameter with a plain error box — our Rich panels at lines 77 and 87 are
  never reached for nonexistent files with wrong extensions.

  FIX:
  1. Remove `exists=True,` from typer.Argument on line 47
  2. Remove `exists=True,` from typer.Option on line 58
  3. After the video extension check (after line 83), add:
       if not video.exists():
           err_console.print(Panel(
               f"File not found: [bold]{video}[/bold]",
               title="[red]Input Error[/red]",
               border_style="red",
           ))
           raise typer.Exit(1)
  4. After the subtitle extension check (after line 92), add the same
     pattern for subtitle.

  NOTE: `resolve_path=True` on a nonexistent path is safe in Typer — it resolves
  to an absolute path even if the file doesn't exist; Path.exists() then returns
  False correctly.

  Test runner to use: typer.testing.CliRunner (from the typer package).
  Import: from typer.testing import CliRunner
  Usage: runner = CliRunner(); result = runner.invoke(app, [...args...])
  The CliRunner captures stdout+stderr in result.output; check result.exit_code.
-->

From src/cinecut/cli.py (key exports):
```python
app = typer.Typer(name="cinecut", ...)

@app.command()
def main(video: Path, subtitle: Path, vibe: str, review: bool = False) -> None: ...
```

Error panel pattern used throughout cli.py:
```python
err_console.print(Panel(
    f"<message>",
    title="[red]Input Error[/red]",
    border_style="red",
))
raise typer.Exit(1)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove exists=True and add manual existence checks in cli.py</name>
  <files>src/cinecut/cli.py</files>
  <action>
    Read src/cinecut/cli.py in full. Make the following targeted changes:

    1. In the VIDEO `typer.Argument(...)` block (around line 47):
       Remove the `exists=True,` line entirely. Keep all other kwargs
       (file_okay, dir_okay, resolve_path, help) unchanged.

    2. In the subtitle `typer.Option(...)` block (around line 58):
       Remove the `exists=True,` line entirely. Keep all other kwargs unchanged.

    3. After the video extension check block (the `raise typer.Exit(1)` at ~line 83),
       insert a manual existence check:
       ```python
       if not video.exists():
           err_console.print(Panel(
               f"File not found: [bold]{video}[/bold]\n"
               f"Check that the path is correct and the file is accessible.",
               title="[red]Input Error[/red]",
               border_style="red",
           ))
           raise typer.Exit(1)
       ```

    4. After the subtitle extension check block (the `raise typer.Exit(1)` at ~line 92),
       insert a matching existence check:
       ```python
       if not subtitle.exists():
           err_console.print(Panel(
               f"File not found: [bold]{subtitle}[/bold]\n"
               f"Check that the path is correct and the file is accessible.",
               title="[red]Input Error[/red]",
               border_style="red",
           ))
           raise typer.Exit(1)
       ```

    The validation order in main() must be:
      1. video extension check (Rich panel + Exit 1)
      2. video existence check (Rich panel + Exit 1)
      3. subtitle extension check (Rich panel + Exit 1)
      4. subtitle existence check (Rich panel + Exit 1)
      5. ... rest of main() unchanged

    Do NOT modify any other logic in cli.py.
  </action>
  <verify>
    python -m pytest tests/test_proxy.py tests/test_subtitles.py tests/test_keyframes.py -q

    All 33 existing tests must pass. (CLI changes do not affect these unit tests.)
  </verify>
  <done>
    cli.py has no `exists=True` on VIDEO or subtitle args.
    cli.py has manual `if not video.exists()` and `if not subtitle.exists()` checks
    inside main(), positioned after the respective extension checks.
    All 33 existing unit tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI validation tests covering extension and existence order</name>
  <files>tests/test_cli.py</files>
  <action>
    Create tests/test_cli.py using typer.testing.CliRunner.

    Import pattern:
    ```python
    import pytest
    from pathlib import Path
    from typer.testing import CliRunner
    from cinecut.cli import app

    runner = CliRunner()
    ```

    Write these test cases (use tmp_path pytest fixture for real files):

    1. test_invalid_video_extension_nonexistent_file
       - Invoke: ["nonexistent_movie.pdf", "--subtitle", "dummy.srt", "--vibe", "action"]
       - Note: neither file exists on disk
       - Assert: result.exit_code == 1
       - Assert: "Unsupported video format" in result.output (our Rich panel fires first)
       - Assert: "File does not exist" NOT in result.output (Typer's plain error must NOT appear)

    2. test_invalid_video_extension_existing_file
       - Create a real tmp file with .pdf extension using tmp_path
       - Invoke: [str(pdf_file), "--subtitle", "dummy.srt", "--vibe", "action"]
       - Assert: result.exit_code == 1
       - Assert: "Unsupported video format" in result.output

    3. test_valid_video_extension_nonexistent_file
       - Invoke: ["nonexistent_movie.mp4", "--subtitle", "dummy.srt", "--vibe", "action"]
       - Note: .mp4 extension is valid but file doesn't exist
       - Assert: result.exit_code == 1
       - Assert: "File not found" in result.output (our existence check fires)
       - Assert: "File does not exist" NOT in result.output (Typer plain error must NOT appear)

    4. test_invalid_subtitle_extension_nonexistent_file
       - Create a real tmp .mp4 file (so video passes extension check)
       - Invoke: [str(mp4_file), "--subtitle", "subs.pdf", "--vibe", "action"]
       - Note: .pdf subtitle does not exist
       - Assert: result.exit_code == 1
       - Assert: "Unsupported subtitle format" in result.output

    5. test_valid_subtitle_extension_nonexistent_file
       - Create a real tmp .mp4 file (so video passes existence check)
       - Create a real tmp .mp4 (video exists), subtitle path does NOT exist but has .srt extension
       - Invoke: [str(mp4_file), "--subtitle", "nonexistent.srt", "--vibe", "action"]
       - Assert: result.exit_code == 1
       - Assert: "File not found" in result.output

    Use `mix_stderr=False` on CliRunner if stderr output needs to be separated:
    `runner = CliRunner(mix_stderr=False)`
    Then check `result.output` for stdout and `result.stderr` for stderr. Since
    err_console writes to stderr and console writes to stdout, check both.
    Alternatively use `mix_stderr=True` (default) and check combined output.

    Use `mix_stderr=True` (the default) for simplicity — check `result.output`
    for all text content including stderr panels.
  </action>
  <verify>
    python -m pytest tests/test_cli.py -v

    All 5 new tests must pass. No existing tests broken.

    Also run the full suite:
    python -m pytest tests/ -q
  </verify>
  <done>
    tests/test_cli.py exists with 5 test functions.
    All 5 tests pass.
    Full test suite (38 tests) passes.
    The tests confirm: wrong-extension files produce "Unsupported * format" panels
    regardless of whether the file exists on disk.
  </done>
</task>

</tasks>

<verification>
After both tasks:

1. `python -m pytest tests/ -q` — all tests pass (33 original + 5 new = 38 total)
2. Manually verify validation ordering by reading cli.py lines 44-100:
   - No `exists=True` on VIDEO or subtitle args
   - Extension checks appear before existence checks in main() body
3. Check that result.output in tests contains Rich panel text (not Click's plain error)
</verification>

<success_criteria>
- `python -m pytest tests/test_cli.py -v` passes all 5 tests
- `python -m pytest tests/ -q` passes all 38 tests
- cli.py VIDEO and subtitle args have no `exists=True`
- cli.py manual existence checks (using `Path.exists()`) follow extension checks in main()
- Wrong-extension nonexistent file shows "Unsupported * format" Rich panel (not Click's plain error)
- Valid-extension nonexistent file shows "File not found" Rich panel
</success_criteria>

<output>
After completion, create `/home/adamh/ai-video-trailer/.planning/phases/01-ingestion-pipeline-and-cli-shell/01-05-SUMMARY.md`
</output>
